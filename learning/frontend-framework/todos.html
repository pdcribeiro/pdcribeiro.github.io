<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>todos</title>
    <link rel="stylesheet" href="/third-party/modern-normalize.min.css" />
    <link rel="stylesheet" href="/style/dark.css" />
    <script type="module" src="./fw.js"></script>
</head>

<body style="padding: 1rem 4rem; margin: auto; max-width: 853px; height: 100dvh">
</body>

<template app>
    <script>
        console.debug('script', { isESModule: typeof import.meta !== "undefined" }) // DEV

        let newTask = $state('')
        let filter = $state('all')
        let tasks = $state([
            { id: 0, title: 'first task', done: true }, { id: 1, title: 'second task', done: false },
        ])

        let tasksByFilter = $derive(() => ({
            all: tasks.val,
            active: tasks.val.filter(t => !t.done),
            completed: tasks.val.filter(t => t.done),
        }))
        let filtered = $derive(() => tasksByFilter[filter.val])
        $derive(() => console.log(tasksByFilter._raw))

        let addTask = () => {
            if (newTask.val) {
                createTask(newTask.val)
                newTask.val = ''
            }
        }
        let createTask = (title) => {
            tasks.val = [...tasks.val, { title, done: false, id: tasks.val.length }]
        }
        let toggleTask = (id) => {
            tasks.val = tasks.val.map(t => t.id === id ? { ...t, done: !t.done } : t)
        }
        let deleteTask = (id) => {
            tasks.val = tasks.val.filter(t => t.id !== id)
        }

        // setInterval(() => {
        //     console.log('STATE', newTask._bindings)
        //     // createTask(`task ${tasks.val.length + 1}`)
        // }, 2000)
    </script>

    <header>
        <h1>Task Tracker</h1>
    </header>

    <div style="display: flex">
        <main style="flex: 1">
            <!-- FIX not clearing input. seems like binding both value and input listener breaks it -->
            <input type="text" :model="newTask" placeholder="New task"
                @input="e => (console.log('input first'), (newTask.val = e.target.value))">
            <button @click="addTask">Add task</button>
            <input type="text" :model="newTask"
                @input="e => (console.log('input second'), (newTask.val = e.target.value))">

            <div>
                <button @click="filter.val = 'all'">All</button>
                <button @click="filter.val = 'active'">Active</button>
                <button @click="filter.val = 'completed'">Completed</button>
            </div>

            <ul>
                <li :for="task in filtered.val">
                    <task-item :task @toggle="toggleTask(task.id)" @delete="deleteTask(task.id)"></task-item>
                </li>
                <li :else>No tasks</li>
            </ul>

            <p :if="!filtered.val.length">What's next?</p>
            <p :elsif="tasksByFilter.completed.length === tasksByFilter.all.length">Great job!</p>
            <p :elsif="filtered.val.length <= 5">Keep it going :)</p>
            <p :else>Take it easy...</p>
        </main>

        <aside>
            <div>
                <p>Total tasks: {tasksByFilter.all.length}</p>
                <p>Active tasks: {tasksByFilter.active.length}</p>
                <p>Completed tasks: {tasksByFilter.completed.length}</p>
            </div>
        </aside>
    </div>
</template>

<template component="TaskItem">
    <script>
        let { task } = $props
    </script>

    <input type="checkbox" :checked="task.done" @input="$emit('toggle')">
    <span>{task.title}</span>
    <delete-button @click="$emit('delete')"></delete-button>
</template>

<template component="DeleteButton">
    <button @click="e => confirm('Are you sure?') || e.stopPropagation()">x</button>

    <style>
        button {
            color: red;
        }
    </style>
</template>

</html>